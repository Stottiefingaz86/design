/**
 * Comprehensive Figma Asset Extractor
 * 
 * Extracts all assets from Figma design files:
 * - Components
 * - Colors (variables and instances)
 * - Typography
 * - Logos
 * - Spacing tokens
 * - Shadows
 * - Border radius
 * - Icons
 * - Patterns
 * 
 * Stores extracted assets in Supabase for persistent knowledge base
 */

// Note: Supabase integration can be added later if needed
// For now, these utilities are placeholders
// When Supabase functions are implemented, uncomment these imports:
// import { addFigmaAsset, addDesignToken } from '@/lib/supabase/knowledgeBase'

interface FigmaFileInfo {
  fileId: string
  fileName: string
  fileUrl: string
}

/**
 * Extract all assets from a Figma file
 * Uses Figma MCP server to get design context and variables
 */
export async function extractAllFigmaAssets(
  fileInfo: FigmaFileInfo,
  nodeId?: string
): Promise<{
  components: number
  colors: number
  typography: number
  spacing: number
  shadows: number
  borderRadius: number
  logos: number
  total: number
}> {
  const stats = {
    components: 0,
    colors: 0,
    typography: 0,
    spacing: 0,
    shadows: 0,
    borderRadius: 0,
    logos: 0,
    total: 0,
  }

  try {
    // Note: This would use Figma MCP tools in production
    // For now, this is a structure for extraction
    
    // 1. Extract Variables (Colors, Spacing, Typography, etc.)
    // const variables = await getFigmaVariables(fileInfo.fileId)
    // await extractVariables(variables, fileInfo)
    
    // 2. Extract Components
    // const components = await getFigmaComponents(fileInfo.fileId, nodeId)
    // await extractComponents(components, fileInfo)
    
    // 3. Extract Logos
    // const logos = await getFigmaLogos(fileInfo.fileId)
    // await extractLogos(logos, fileInfo)
    
    console.log(`‚úÖ Extracted ${stats.total} assets from ${fileInfo.fileName}`)
    return stats
  } catch (error) {
    console.error('Error extracting Figma assets:', error)
    return stats
  }
}

/**
 * Extract design tokens from Figma variables
 */
async function extractVariables(
  variables: any[],
  fileInfo: FigmaFileInfo
): Promise<void> {
  for (const variable of variables) {
    const tokenType = getVariableType(variable)
    
    if (tokenType === 'color') {
      const token: Omit<DesignToken, 'id'> = {
        tokenType: 'color',
        tokenName: variable.name,
        tokenValue: variable.values?.mode?.value || variable.value || '',
        description: variable.description,
        figmaLink: `${fileInfo.fileUrl}?node-id=${variable.id}`,
        brand: extractBrandFromName(variable.name),
      }
      await addDesignToken(token)
    } else if (tokenType === 'spacing') {
      const token: Omit<DesignToken, 'id'> = {
        tokenType: 'spacing',
        tokenName: variable.name,
        tokenValue: variable.values?.mode?.value || variable.value || '',
        description: variable.description,
        figmaLink: `${fileInfo.fileUrl}?node-id=${variable.id}`,
      }
      await addDesignToken(token)
    } else if (tokenType === 'typography') {
      const token: Omit<DesignToken, 'id'> = {
        tokenType: 'typography',
        tokenName: variable.name,
        tokenValue: JSON.stringify(variable.values),
        description: variable.description,
        figmaLink: `${fileInfo.fileUrl}?node-id=${variable.id}`,
      }
      await addDesignToken(token)
    }
  }
}

/**
 * Extract components from Figma
 */
async function extractComponents(
  components: any[],
  fileInfo: FigmaFileInfo
): Promise<void> {
  for (const component of components) {
    const asset: Omit<FigmaAsset, 'id' | 'extractedAt' | 'updatedAt'> = {
      figmaFileId: fileInfo.fileId,
      figmaFileName: fileInfo.fileName,
      figmaFileUrl: fileInfo.fileUrl,
      assetType: 'component',
      assetName: component.name,
      assetData: {
        id: component.id,
        name: component.name,
        description: component.description,
        properties: component.componentPropertyDefinitions,
        variants: component.variants,
        usage: component.instances?.length || 0,
      },
    }
    
    await addFigmaAsset({
      ...asset,
      id: `figma-${fileInfo.fileId}-${component.id}`,
    })
  }
}

/**
 * Determine variable type from name or structure
 */
function getVariableType(variable: any): 'color' | 'spacing' | 'typography' | 'shadow' | 'border-radius' | 'unknown' {
  const name = variable.name?.toLowerCase() || ''
  
  if (name.includes('color') || name.includes('colour') || name.includes('rgb') || name.includes('hex')) {
    return 'color'
  }
  if (name.includes('spacing') || name.includes('padding') || name.includes('margin') || name.includes('gap')) {
    return 'spacing'
  }
  if (name.includes('font') || name.includes('typography') || name.includes('text') || name.includes('heading')) {
    return 'typography'
  }
  if (name.includes('shadow') || name.includes('elevation')) {
    return 'shadow'
  }
  if (name.includes('radius') || name.includes('border')) {
    return 'border-radius'
  }
  
  return 'unknown'
}

/**
 * Extract brand name from token name
 */
function extractBrandFromName(name: string): string | undefined {
  const brands = ['BetOnline', 'WildCasino', 'TigerGaming', 'LowVig', 'SportsBetting', 'HighRoller', 'GamingCity', 'QueenBee', 'SuperSlots']
  
  for (const brand of brands) {
    if (name.toLowerCase().includes(brand.toLowerCase())) {
      return brand
    }
  }
  
  return undefined
}

/**
 * Batch extract from multiple Figma files
 */
export async function extractFromMultipleFiles(
  files: FigmaFileInfo[]
): Promise<void> {
  console.log(`üì¶ Extracting assets from ${files.length} Figma files...`)
  
  for (const file of files) {
    try {
      const stats = await extractAllFigmaAssets(file)
      console.log(`‚úÖ ${file.fileName}: ${stats.total} assets extracted`)
    } catch (error) {
      console.error(`‚ùå Error extracting from ${file.fileName}:`, error)
    }
  }
  
  console.log('‚úÖ All Figma assets extracted and stored in knowledge base')
}
