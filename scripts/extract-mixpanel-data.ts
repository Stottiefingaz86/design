/**
 * Extract Mixpanel Analytics Data
 * This script extracts all Mixpanel retention/cohort data and stores it in Supabase
 */

import { addKnowledgeNote } from '../lib/supabase/knowledgeBase'

interface CohortData {
  date: string
  totalProfiles: string
  retention: { [day: string]: string }
}

// All detailed retention data extracted from images
const mixpanelRetentionData = {
  weightedAverage: {
    '<1': '59.91%',
    '1': '14.9%',
    '2': '13.86%',
    '3': '13.19%',
    '4': '12.66%',
    '5': '12.19%',
    '6': '11.83%',
    '7': '11.38%',
    '8': '10.95%',
    '9': '10.67%',
    '10': '10.42%',
    '11': '10.19%',
    '12': '9.96%',
    '13': '9.73%',
    '14': '9.43%',
    '15': '9.11%',
    '16': '9.22%',
    '17': '9.04%',
    '18': '8.87%',
    '19': '8.7%',
    '20': '8.53%',
    '21': '8.29%',
    '22': '8.04%',
    '23': '7.87%',
    '24': '7.71%',
    '25': '7.56%',
    '26': '7.42%',
    '27': '7.26%',
    '28': '7.04%',
    '29': '6.81%',
    '30': '6.65%',
    '31': '6.51%',
    '32': '6.37%',
    '33': '6.24%',
    '34': '6.1%',
    '35': '5.91%',
    '36': '5.7%',
    '37': '5.54%',
    '38': '5.41%',
    '39': '5.28%',
    '40': '5.15%',
    '41': '5.01%',
    '42': '4.82%',
    '43': '4.61%',
    '44': '4.45%',
    '45': '4.31%',
    '46': '4.16%',
    '47': '3.99%',
    '48': '3.84%',
    '49': '3.64%',
    '50': '3.41%',
    '51': '3.24%',
    '52': '3.08%',
    '53': '2.91%',
  },
  cohorts: [
    {
      date: 'Jan 1, 2025',
      totalProfiles: '4.4M',
      retention: {
        '<1': '45.01%', '1': '14.66%', '2': '13.8%', '3': '13.26%', '4': '12.83%', '5': '12.47%',
        '6': '12.16%', '7': '11.72%', '8': '11.29%', '9': '10.99%', '10': '10.75%', '11': '10.53%',
        '12': '10.34%', '13': '10.15%', '14': '9.87%', '15': '9.58%', '16': '9.39%', '17': '9.22%',
        '18': '9.06%', '19': '8.91%', '20': '8.76%', '21': '8.62%', '22': '8.48%', '23': '8.35%',
        '24': '8.22%', '25': '8.1%', '26': '7.66%', '27': '7.52%', '28': '7.39%', '29': '7.27%',
        '30': '7.14%', '31': '7.01%', '32': '6.88%', '33': '6.76%', '34': '6.63%', '35': '6.24%',
        '36': '6.06%', '37': '5.91%', '38': '5.77%', '39': '5.62%', '40': '5.46%', '41': '5.32%',
        '42': '5.14%', '43': '4.97%', '44': '4.84%', '45': '4.71%', '46': '4.57%', '47': '4.43%',
        '48': '4.28%', '49': '4.06%', '50': '3.82%', '51': '3.64%', '52': '3.46%', '53': '3.26%',
      },
    },
    {
      date: 'Feb 1, 2025',
      totalProfiles: '5.9M',
      retention: {
        '<1': '58.26%', '1': '13.59%', '2': '12.65%', '3': '12.05%', '4': '11.57%', '5': '11.17%',
        '6': '10.84%', '7': '10.48%', '8': '10.12%', '9': '9.89%', '10': '9.69%', '11': '9.5%',
        '12': '9.33%', '13': '9.16%', '14': '8.94%', '15': '8.71%', '16': '8.55%', '17': '8.41%',
        '18': '8.26%', '19': '8.12%', '20': '7.99%', '21': '7.87%', '22': '7.75%', '23': '7.64%',
        '24': '7.53%', '25': '7.42%', '26': '7.04%', '27': '6.91%', '28': '6.78%', '29': '6.66%',
        '30': '6.54%', '31': '6.42%', '32': '6.31%', '33': '6.2%', '34': '6.09%', '35': '5.7%',
        '36': '5.52%', '37': '5.4%', '38': '5.28%', '39': '5.16%', '40': '5.03%', '41': '4.9%',
        '42': '4.73%', '43': '4.56%', '44': '4.42%', '45': '4.29%', '46': '4.17%', '47': '4.04%',
        '48': '3.89%', '49': '3.7%', '50': '3.5%', '51': '3.34%', '52': '3.19%', '53': '3.02%',
      },
    },
    {
      date: 'Mar 1, 2025',
      totalProfiles: '7.4M',
      retention: {
        '<1': '35.98%', '1': '13.69%', '2': '12.7%', '3': '12.1%', '4': '11.63%', '5': '11.2%',
        '6': '10.86%', '7': '10.49%', '8': '10.15%', '9': '9.92%', '10': '9.7%', '11': '9.51%',
        '12': '9.32%', '13': '9.13%', '14': '8.9%', '15': '8.69%', '16': '8.51%', '17': '8.35%',
        '18': '8.2%', '19': '8.06%', '20': '7.92%', '21': '7.79%', '22': '7.66%', '23': '7.54%',
        '24': '7.42%', '25': '7.3%', '26': '6.92%', '27': '6.76%', '28': '6.61%', '29': '6.47%',
        '30': '6.33%', '31': '6.19%', '32': '6.06%', '33': '5.93%', '34': '5.8%', '35': '5.45%',
        '36': '5.27%', '37': '5.13%', '38': '4.99%', '39': '4.86%', '40': '4.72%', '41': '4.58%',
        '42': '4.41%', '43': '4.23%', '44': '4.08%', '45': '3.94%', '46': '3.79%', '47': '3.65%',
        '48': '3.49%', '49': '3.29%', '50': '3.09%', '51': '2.92%', '52': '2.75%', '53': '2.58%',
      },
    },
    {
      date: 'Apr 1, 2025',
      totalProfiles: '7.7M',
      retention: {
        '<1': '35.29%', '1': '13.3%', '2': '12.28%', '3': '11.62%', '4': '11.06%', '5': '10.62%',
        '6': '10.26%', '7': '9.88%', '8': '9.53%', '9': '9.26%', '10': '9.02%', '11': '8.78%',
        '12': '8.57%', '13': '8.36%', '14': '8.12%', '15': '7.87%', '16': '7.66%', '17': '7.48%',
        '18': '7.3%', '19': '7.13%', '20': '6.96%', '21': '6.8%', '22': '6.64%', '23': '6.49%',
        '24': '6.34%', '25': '6.19%', '26': '5.94%', '27': '5.8%', '28': '5.66%', '29': '5.53%',
        '30': '5.4%', '31': '5.27%', '32': '5.14%', '33': '5.02%', '34': '4.9%', '35': '4.67%',
        '36': '4.51%', '37': '4.39%', '38': '4.27%', '39': '4.15%', '40': '4.03%', '41': '3.92%',
        '42': '3.79%', '43': '3.65%', '44': '3.52%', '45': '3.41%', '46': '3.3%', '47': '3.19%',
        '48': '3.07%', '49': '2.92%', '50': '2.76%', '51': '2.63%', '52': '2.49%', '53': '2.34%',
      },
    },
    {
      date: 'May 1, 2025',
      totalProfiles: '6.4M',
      retention: {
        '<1': '33.42%', '1': '13.27%', '2': '12.31%', '3': '11.71%', '4': '11.23%', '5': '10.81%',
        '6': '10.48%', '7': '10.14%', '8': '9.82%', '9': '9.57%', '10': '9.35%', '11': '9.16%',
        '12': '8.97%', '13': '8.79%', '14': '8.58%', '15': '8.38%', '16': '8.21%', '17': '8.06%',
        '18': '7.92%', '19': '7.78%', '20': '7.65%', '21': '7.53%', '22': '7.41%', '23': '7.3%',
        '24': '7.19%', '25': '7.08%', '26': '6.76%', '27': '6.62%', '28': '6.49%', '29': '6.36%',
        '30': '6.23%', '31': '6.11%', '32': '5.99%', '33': '5.87%', '34': '5.75%', '35': '5.5%',
        '36': '5.33%', '37': '5.21%', '38': '5.09%', '39': '4.97%', '40': '4.85%', '41': '4.72%',
        '42': '4.56%', '43': '4.39%', '44': '4.23%', '45': '4.09%', '46': '3.96%', '47': '3.81%',
        '48': '3.65%', '49': '3.45%', '50': '3.21%', '51': '3.04%', '52': '2.87%', '53': '2.7%',
      },
    },
    {
      date: 'Jun 1, 2025',
      totalProfiles: '6.7M',
      retention: {
        '<1': '34.62%', '1': '12.67%', '2': '11.92%', '3': '11.35%', '4': '10.91%', '5': '10.56%',
        '6': '10.26%', '7': '9.93%', '8': '9.64%', '9': '9.42%', '10': '9.22%', '11': '9.03%',
        '12': '8.85%', '13': '8.67%', '14': '8.39%', '15': '8.11%', '16': '7.95%', '17': '7.79%',
        '18': '7.63%', '19': '7.48%', '20': '7.34%', '21': '7.2%', '22': '7.07%', '23': '6.94%',
        '24': '6.81%', '25': '6.69%', '26': '6.24%', '27': '6.11%', '28': '5.98%', '29': '5.86%',
        '30': '5.74%', '31': '5.62%', '32': '5.5%', '33': '5.38%', '34': '5.27%', '35': '4.96%',
        '36': '4.78%', '37': '4.66%', '38': '4.55%', '39': '4.43%', '40': '4.32%', '41': '4.2%',
        '42': '4.02%', '43': '3.84%', '44': '3.72%', '45': '3.61%', '46': '3.5%', '47': '3.39%',
        '48': '3.27%', '49': '3.05%', '50': '2.84%', '51': '2.71%', '52': '2.58%', '53': '2.44%',
      },
    },
    {
      date: 'Jul 1, 2025',
      totalProfiles: '6.2M',
      retention: {
        '<1': '32.76%', '1': '13.14%', '2': '12.24%', '3': '11.7%', '4': '11.24%', '5': '10.85%',
        '6': '10.56%', '7': '10.19%', '8': '9.85%', '9': '9.6%', '10': '9.4%', '11': '9.2%',
        '12': '9.02%', '13': '8.84%', '14': '8.63%', '15': '8.42%', '16': '8.26%', '17': '8.11%',
        '18': '7.97%', '19': '7.84%', '20': '7.71%', '21': '7.59%', '22': '7.47%', '23': '7.36%',
        '24': '7.25%', '25': '7.14%', '26': '6.76%', '27': '6.62%', '28': '6.49%', '29': '6.36%',
        '30': '6.23%', '31': '6.11%', '32': '5.99%', '33': '5.87%', '34': '5.75%', '35': '5.45%',
        '36': '5.28%', '37': '5.16%', '38': '5.04%', '39': '4.93%', '40': '4.82%', '41': '4.71%',
        '42': '4.55%', '43': '4.39%', '44': '4.25%', '45': '4.13%', '46': '3.99%', '47': '3.86%',
        '48': '3.72%', '49': '3.55%', '50': '3.36%', '51': '3.2%', '52': '3.05%', '53': '2.89%',
      },
    },
    {
      date: 'Aug 1, 2025',
      totalProfiles: '6.5M',
      retention: {
        '<1': '32.8%', '1': '13.68%', '2': '12.78%', '3': '12.26%', '4': '11.86%', '5': '11.5%',
        '6': '11.19%', '7': '10.82%', '8': '10.47%', '9': '10.22%', '10': '10.02%', '11': '9.84%',
        '12': '9.67%', '13': '9.48%', '14': '9.23%', '15': '8.97%', '16': '8.76%', '17': '8.59%',
        '18': '8.44%', '19': '8.3%', '20': '8.17%', '21': '8.05%', '22': '7.94%', '23': '7.83%',
        '24': '7.72%', '25': '7.61%', '26': '7.11%', '27': '6.96%', '28': '6.82%', '29': '6.69%',
        '30': '6.56%', '31': '6.44%', '32': '6.32%', '33': '6.2%', '34': '6.08%', '35': '5.7%',
        '36': '5.5%', '37': '5.35%', '38': '5.23%', '39': '5.12%', '40': '5.01%', '41': '4.9%',
        '42': '4.75%', '43': '4.55%', '44': '4.4%', '45': '4.27%', '46': '4.15%', '47': '4.03%',
        '48': '3.89%', '49': '3.71%', '50': '3.48%', '51': '3.3%', '52': '3.14%', '53': '2.99%',
      },
    },
    {
      date: 'Sep 1, 2025',
      totalProfiles: '7.4M',
      retention: {
        '<1': '49.5%', '1': '17.63%', '2': '16.57%', '3': '15.93%', '4': '15.44%', '5': '14.98%',
        '6': '14.6%', '7': '14.07%', '8': '13.56%', '9': '13.24%', '10': '12.97%', '11': '12.73%',
        '12': '12.5%', '13': '12.26%', '14': '11.9%', '15': '11.52%', '16': '11.29%', '17': '11.08%',
        '18': '10.89%', '19': '10.71%', '20': '10.54%', '21': '10.38%', '22': '10.22%', '23': '10.07%',
        '24': '9.92%', '25': '9.77%', '26': '9.09%', '27': '8.9%', '28': '8.71%', '29': '8.53%',
        '30': '8.36%', '31': '8.19%', '32': '8.03%', '33': '7.87%', '34': '7.71%', '35': '7.13%',
        '36': '6.85%', '37': '6.64%', '38': '6.48%', '39': '6.33%', '40': '6.18%', '41': '6.02%',
        '42': '5.8%', '43': '5.57%', '44': '5.4%', '45': '5.24%', '46': '5.09%', '47': '4.93%',
        '48': '4.74%', '49': '4.5%', '50': '4.23%', '51': '4.03%', '52': '3.84%', '53': '3.64%',
      },
    },
    {
      date: 'Oct 1, 2025',
      totalProfiles: '8.9M',
      retention: {
        '<1': '90.41%', '1': '16.24%', '2': '15.17%', '3': '14.49%', '4': '13.93%', '5': '13.45%',
        '6': '13.07%', '7': '12.61%', '8': '12.15%', '9': '11.85%', '10': '11.58%', '11': '11.35%',
        '12': '11.13%', '13': '10.9%', '14': '10.6%', '15': '10.27%', '16': '10.02%', '17': '9.8%',
        '18': '9.6%', '19': '9.41%', '20': '9.23%', '21': '9.05%', '22': '8.88%', '23': '8.72%',
        '24': '8.56%', '25': '8.4%', '26': '8.04%', '27': '7.89%', '28': '7.74%', '29': '7.59%',
        '30': '7.45%', '31': '7.31%', '32': '7.17%', '33': '7.03%', '34': '6.89%', '35': '6.54%',
        '36': '6.31%', '37': '6.17%', '38': '6.04%', '39': '5.9%', '40': '5.77%', '41': '5.62%',
        '42': '5.41%', '43': '5.15%', '44': '4.98%', '45': '4.83%', '46': '4.68%', '47': '4.52%',
        '48': '4.36%', '49': '4.13%', '50': '3.84%', '51': '3.65%', '52': '3.46%', '53': '3.27%',
      },
    },
    {
      date: 'Nov 1, 2025',
      totalProfiles: '9.8M',
      retention: {
        '<1': '89.57%', '1': '17.53%', '2': '16.33%', '3': '15.55%', '4': '14.93%', '5': '14.37%',
        '6': '13.97%', '7': '13.39%', '8': '12.86%', '9': '12.55%', '10': '12.27%', '11': '12.03%',
        '12': '11.78%', '13': '11.54%', '14': '11.19%', '15': '10.78%', '16': '10.55%', '17': '10.35%',
        '18': '10.17%', '19': '10%', '20': '9.84%', '21': '9.68%', '22': '9.53%', '23': '9.38%',
        '24': '9.23%', '25': '9.08%', '26': '8.46%', '27': '8.27%', '28': '8.09%', '29': '7.91%',
        '30': '7.74%', '31': '7.57%', '32': '7.4%', '33': '7.23%', '34': '7.06%', '35': '6.6%',
        '36': '6.33%', '37': '6.13%', '38': '5.97%', '39': '5.82%', '40': '5.67%', '41': '5.5%',
        '42': '5.25%', '43': '4.96%', '44': '4.72%*', '45': '4.53%', '46': '4.33%', '47': '4.11%*',
        '48': '3.91%*', '49': '3.63%*', '50': '3.34%*', '51': '3.14%*', '52': '2.96%*', '53': '2.79%*',
      },
    },
    {
      date: 'Dec 1, 2025',
      totalProfiles: '9.9M',
      retention: {
        '<1': '89.23%', '1': '14.83%', '2': '13.57%', '3': '12.71%', '4': '12.06%', '5': '11.46%',
        '6': '11%', '7': '10.44%', '8': '9.9%', '9': '9.54%', '10': '9.22%', '11': '8.91%',
        '12': '8.59%', '13': '8.24%', '14': '7.79%', '15': '7.35%', '16': '7.04%*', '17': '6.75%*',
        '18': '6.49%*', '19': '6.25%*', '20': '6.01%*', '21': '5.78%*', '22': '5.55%*', '23': '5.33%*',
        '24': '5.11%*', '25': '4.9%*', '26': '4.26%*', '27': '4.01%*', '28': '3.77%*', '29': '3.54%*',
        '30': '3.31%*', '31': '3.09%*', '32': '2.87%*', '33': '2.66%*', '34': '2.46%*', '35': '2.21%*',
        '36': '1.96%*', '37': '1.75%*', '38': '1.58%*', '39': '1.41%*', '40': '1.24%*', '41': '1.07%*',
        '42': '0.91%*', '43': '0.75%*', '44': '0.62%*', '45': '0.44%*', '46': '0.27%*', '47': '0.04%*',
      },
    },
    {
      date: 'Jan 1, 2026',
      totalProfiles: '6.2M',
      retention: {
        '<1': '72.06%*', '1': '10.15%*', '2': '8.52%*', '3': '7.46%*', '4': '6.63%*', '5': '5.94%*',
        '6': '5.34%*', '7': '4.58%*', '8': '3.8%*', '9': '3.15%*', '10': '2.61%*', '11': '2.14%*',
        '12': '1.71%*', '13': '1.32%*', '14': '0.89%*', '15': '0.54%*', '16': '0.07%*',
      },
    },
  ],
}

async function extractAndStoreMixpanelData() {
  console.log('üìä Extracting Mixpanel Analytics Data...\n')

  try {
    // Store weighted average data
    const weightedAvgContent = `**Mixpanel Analytics - Weighted Average Retention**\nSource: Mixpanel\nMetric: Profile Retention (Weighted Average)\n\n**Daily Retention Percentages (Day <1 through Day 53):**\n${Object.entries(mixpanelRetentionData.weightedAverage)
      .map(([day, value]) => `- Day ${day}: ${value}`)
      .join('\n')}\n\nThis represents the weighted average retention across all cohorts for each day from Day <1 through Day 53.`

    await addKnowledgeNote({
      title: 'Mixpanel Analytics - Weighted Average Retention',
      content: weightedAvgContent,
      category: 'insights',
      tags: ['mixpanel', 'retention', 'analytics', 'weighted-average'],
    })
    console.log('‚úÖ Stored weighted average data')

    // Store detailed cohort data
    for (const cohort of mixpanelRetentionData.cohorts) {
      const days = Object.keys(cohort.retention)
        .sort((a, b) => {
          if (a === '<1') return -1
          if (b === '<1') return 1
          return parseInt(a) - parseInt(b)
        })
        .map(day => `- Day ${day}: ${cohort.retention[day]}`)
        .join('\n')

      const cohortContent = `**Mixpanel Analytics - Cohort Retention: ${cohort.date}**\nSource: Mixpanel\nMetric: Profile Retention by Cohort\nTotal Profiles: ${cohort.totalProfiles}\n\n**Daily Retention Percentages:**\n${days}\n\nThis cohort represents users acquired on ${cohort.date}, tracking their retention through Day 53 (or as available).`

      await addKnowledgeNote({
        title: `Mixpanel Analytics - Cohort ${cohort.date}`,
        content: cohortContent,
        category: 'insights',
        tags: ['mixpanel', 'retention', 'analytics', 'cohort', cohort.date.toLowerCase().replace(/\s+/g, '-')],
      })
      console.log(`‚úÖ Stored cohort data for ${cohort.date}`)
    }

    // Store session start events data
    const sessionStartContent = `**Mixpanel Analytics - Session Start Events**\nSource: Mixpanel\nMetric: Total Events of Session Start\nAverage: 13.1M\n\n**Last 12 Months (most recent first):**\n- 9.49M\n- 10.55M\n- 13.03M\n- 13.21M\n- 11.38M\n- 11.5M\n- 10.72M\n- 11.59M\n- 15.07M\n- 17.33M\n- 18.45M\n- 18.06M\n- 9.91M\n\nThis metric tracks the total number of session start events across the platform, providing insights into user engagement and platform activity levels.`

    await addKnowledgeNote({
      title: 'Mixpanel Analytics - Session Start Events',
      content: sessionStartContent,
      category: 'insights',
      tags: ['mixpanel', 'session-start', 'analytics', 'events'],
    })
    console.log('‚úÖ Stored session start events data')

    console.log('\n‚úÖ All Mixpanel data extracted and stored in Supabase!')
    console.log(`üìä Stored ${mixpanelRetentionData.cohorts.length + 2} knowledge notes`)
  } catch (error) {
    console.error('‚ùå Error extracting Mixpanel data:', error)
    throw error
  }
}

// Run if executed directly
if (require.main === module) {
  extractAndStoreMixpanelData()
    .then(() => {
      console.log('\n‚úÖ Done!')
      process.exit(0)
    })
    .catch((error) => {
      console.error('\n‚ùå Failed:', error)
      process.exit(1)
    })
}

export { extractAndStoreMixpanelData, mixpanelRetentionData }
